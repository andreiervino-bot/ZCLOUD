<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BackupApp ‚Ä¢ Seus arquivos em seguran√ßa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --sidebar-w: 280px; }
    html, body { height: 100%; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; }
    .scroll-smooth { scroll-behavior: smooth; }
    .hide { display: none !important; }
    .dropzone.dragover { outline: 2px dashed #3b82f6; background: #f1f5f9; }
    .btn-primary { background-color: #3b82f6; color: white; }
    .btn-primary:hover { background-color: #2563eb; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Toasts -->
  <div id="toast-container" class="fixed top-4 right-4 space-y-3 z-50"></div>

  <!-- App Shell -->
  <div id="app" class="min-h-screen flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-[var(--sidebar-w)] shrink-0 bg-white border-r border-slate-200 hidden">
      <div class="p-4 border-b border-slate-200 flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-blue-600 flex items-center justify-center text-white font-bold">B</div>
        <div>
          <div class="text-sm text-slate-500">BackupApp</div>
          <div class="text-lg font-bold">Painel</div>
        </div>
      </div>
      <nav class="p-3 space-y-2">
        <button data-route="#/dashboard" class="navlink w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-blue-50">
          <span>üè†</span><span>Dashboard</span>
        </button>
        <button data-route="#/backups" class="navlink w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-blue-50">
          <span>üóÇÔ∏è</span><span>Backups</span>
        </button>
        <button data-route="#/plans" class="navlink w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-blue-50">
          <span>üì¶</span><span>Planos</span>
        </button>
        <button data-route="#/account" class="navlink w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-blue-50">
          <span>üë§</span><span>Minha conta</span>
        </button>
        <div id="adminOnly" class="hidden">
          <div class="text-[10px] uppercase tracking-widest font-semibold text-slate-400 px-3 pt-4">Admin</div>
          <button data-route="#/admin" class="navlink w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-blue-50">
            <span>üõ°Ô∏è</span><span>Console Admin</span>
          </button>
        </div>
        <div class="pt-4 border-t border-slate-200 mt-2">
          <button id="btn-logout" class="w-full flex items-center justify-center gap-2 px-3 py-2 rounded-xl bg-slate-900 text-white hover:opacity-90">
            <span>üö™</span><span>Sair</span>
          </button>
        </div>
      </nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 min-w-0">
      <!-- Topbar -->
      <header id="topbar" class="hidden bg-white border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <button id="btn-open-sidebar" class="lg:hidden px-2 py-1 rounded-lg hover:bg-slate-100">‚ò∞</button>
            <h1 id="page-title" class="text-xl font-bold">Dashboard</h1>
          </div>
          <div class="flex items-center gap-4">
            <div id="quota-mini" class="hidden lg:flex items-center gap-2 text-sm"></div>
            <div id="user-mini" class="flex items-center gap-2 text-sm text-slate-600"></div>
          </div>
        </div>
      </header>

      <!-- Views container -->
      <section id="views" class="max-w-7xl mx-auto p-4">
        <!-- Auth: Login -->
        <div id="view-login" class="max-w-md mx-auto mt-16">
          <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm">
            <h2 class="text-2xl font-bold mb-1">Entrar</h2>
            <p class="text-sm text-slate-500 mb-6">Acesse sua conta para gerenciar seus backups.</p>
            <form id="form-login" class="space-y-3">
              <div>
                <label class="text-sm font-medium">Email</label>
                <input type="email" name="email" required class="mt-1 w-full border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
              </div>
              <div>
                <label class="text-sm font-medium">Senha</label>
                <input type="password" name="password" required class="mt-1 w-full border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
              </div>
              <button type="submit" class="w-full bg-blue-600 text-white rounded-xl px-4 py-2 font-semibold hover:opacity-90">Entrar</button>
            </form>
            <p class="text-sm text-slate-600 mt-4">N√£o tem conta? <a href="#/register" class="text-blue-600 font-semibold">Criar conta</a></p>
          </div>
        </div>

        <!-- Auth: Register -->
        <div id="view-register" class="max-w-md mx-auto mt-16 hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm">
            <h2 class="text-2xl font-bold mb-1">Criar conta</h2>
            <p class="text-sm text-slate-500 mb-6">Registre-se para come√ßar a fazer backup dos seus arquivos.</p>
            <form id="form-register" class="space-y-3">
              <div>
                <label class="text-sm font-medium">Nome</label>
                <input type="text" name="name" required class="mt-1 w-full border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
              </div>
              <div>
                <label class="text-sm font-medium">Email</label>
                <input type="email" name="email" required class="mt-1 w-full border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
              </div>
              <div>
                <label class="text-sm font-medium">Senha</label>
                <input type="password" name="password" required class="mt-1 w-full border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
              </div>
              <button type="submit" class="w-full bg-blue-600 text-white rounded-xl px-4 py-2 font-semibold hover:opacity-90">Cadastrar</button>
            </form>
            <p class="text-sm text-slate-600 mt-4">J√° tem conta? <a href="#/login" class="text-blue-600 font-semibold">Entrar</a></p>
          </div>
        </div>

        <!-- Dashboard -->
        <div id="view-dashboard" class="hidden">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white border border-slate-200 rounded-2xl p-5">
              <div class="text-sm text-slate-500">Uso de armazenamento</div>
              <div class="mt-2 text-3xl font-extrabold" id="stat-used">‚Äî</div>
              <div class="text-sm text-slate-600" id="stat-total">‚Äî</div>
              <div class="mt-4 h-3 w-full bg-slate-100 rounded-full overflow-hidden">
                <div id="bar-usage" class="h-full bg-blue-600" style="width:0%"></div>
              </div>
              <div class="mt-2 text-xs text-slate-500" id="stat-free">‚Äî</div>
            </div>
            <div class="bg-white border border-slate-200 rounded-2xl p-5">
              <div class="text-sm text-slate-500">Itens enviados</div>
              <div class="mt-2 text-3xl font-extrabold" id="stat-items">‚Äî</div>
              <div class="text-sm text-slate-600">Arquivos e pastas no seu cofre</div>
            </div>
            <div class="bg-white border border-slate-200 rounded-2xl p-5">
              <div class="text-sm text-slate-500">Plano atual</div>
              <div class="mt-2 text-3xl font-extrabold" id="stat-plan">‚Äî</div>
              <div class="text-sm text-slate-600">Renova√ß√£o: <span id="stat-renewal">‚Äî</span></div>
              <a href="#/plans" class="mt-3 inline-block text-sm font-semibold text-blue-600">Alterar plano ‚Üí</a>
            </div>
          </div>

          <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="bg-white border border-slate-200 rounded-2xl p-5 lg:col-span-2">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-bold">Arquivos recentes</h3>
                <a href="#/backups" class="text-sm text-blue-600">Ver todos</a>
              </div>
              <div id="recent-files" class="text-sm text-slate-600">Carregando‚Ä¶</div>
            </div>
            <div class="bg-white border border-slate-200 rounded-2xl p-5">
              <h3 class="font-bold mb-3">Atividade</h3>
              <ul id="activity" class="space-y-2 text-sm text-slate-600"></ul>
            </div>
          </div>
        </div>

        <!-- Backups / File manager -->
        <div id="view-backups" class="hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div>
                <h3 class="font-bold text-lg">Arquivos</h3>
                <div id="current-path" class="text-sm text-slate-500">/</div>
              </div>
              <div class="flex items-center gap-2">
                <input id="file-search" placeholder="Pesquisar‚Ä¶" class="border-slate-300 rounded-xl" />
                <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-900 text-white cursor-pointer">
                  <input id="file-input" type="file" class="hidden" multiple />
                  <span>‚¨ÜÔ∏è Enviar</span>
                </label>
                <button id="btn-create-folder" class="px-3 py-2 rounded-xl bg-blue-600 text-white hover:opacity-90">
                  üìÅ Nova Pasta
                </button>
              </div>
            </div>

            <div id="dropzone" class="dropzone mt-4 p-6 rounded-2xl border-2 border-dashed border-slate-300 text-center text-slate-500">
              Arraste e solte arquivos aqui para enviar
            </div>

            <div class="mt-4 overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="text-left text-slate-500 border-b">
                    <th class="py-2">Nome</th>
                    <th class="py-2">Tamanho</th>
                    <th class="py-2">Modificado</th>
                    <th class="py-2 text-right">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="files-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Plans -->
        <div id="view-plans" class="hidden">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="plan-card bg-white border border-slate-200 rounded-2xl p-6">
              <h3 class="text-xl font-bold">Free</h3>
              <p class="text-sm text-slate-600">Perfeito pra come√ßar</p>
              <div class="text-3xl font-extrabold mt-4">R$ 0<span class="text-base font-semibold text-slate-500">/m√™s</span></div>
              <ul class="mt-4 text-sm text-slate-600 space-y-1">
                <li>5 GB</li>
                <li>Upload limitado a 100 MB</li>
                <li>Suporte comunit√°rio</li>
              </ul>
              <button data-plan-id="free" class="btn-select-plan mt-6 w-full bg-blue-600 text-white rounded-xl px-4 py-2 font-semibold hover:opacity-90">Selecionar</button>
            </div>
            <div class="plan-card bg-white border border-slate-200 rounded-2xl p-6 ring-2 ring-blue-600">
              <div class="inline-block text-xs bg-blue-600 text-white px-2 py-1 rounded-full mb-2">Popular</div>
              <h3 class="text-xl font-bold">Pro</h3>
              <p class="text-sm text-slate-600">Pra quem faz backup s√©rio</p>
              <div class="text-3xl font-extrabold mt-4">R$ 19<span class="text-base font-semibold text-slate-500">/m√™s</span></div>
              <ul class="mt-4 text-sm text-slate-600 space-y-1">
                <li>200 GB</li>
                <li>Upload at√© 5 GB</li>
                <li>Suporte por email</li>
              </ul>
              <button data-plan-id="pro" class="btn-select-plan mt-6 w-full bg-blue-600 text-white rounded-xl px-4 py-2 font-semibold hover:opacity-90">Selecionar</button>
            </div>
            <div class="plan-card bg-white border border-slate-200 rounded-2xl p-6">
              <h3 class="text-xl font-bold">Turbo</h3>
              <p class="text-sm text-slate-600">Empresas e equipes</p>
              <div class="text-3xl font-extrabold mt-4">R$ 49<span class="text-base font-semibold text-slate-500">/m√™s</span></div>
              <ul class="mt-4 text-sm text-slate-600 space-y-1">
                <li>2 TB</li>
                <li>Upload at√© 20 GB</li>
                <li>Suporte priorit√°rio</li>
              </ul>
              <button data-plan-id="turbo" class="btn-select-plan mt-6 w-full bg-blue-600 text-white rounded-xl px-4 py-2 font-semibold hover:opacity-90">Selecionar</button>
            </div>
          </div>
        </div>

        <!-- Account -->
        <div id="view-account" class="hidden">
          <div class="bg-white border border-slate-200 rounded-2xl p-6">
            <h3 class="font-bold text-lg mb-4">Dados da conta</h3>
            <div id="account-data" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"></div>
          </div>
        </div>

        <!-- Admin -->
        <div id="view-admin" class="hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="bg-white border border-slate-200 rounded-2xl p-4 lg:col-span-2">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-bold text-lg">Usu√°rios</h3>
                <input id="admin-user-search" placeholder="Buscar‚Ä¶" class="border-slate-300 rounded-xl" />
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="text-left text-slate-500 border-b">
                      <th class="py-2">Nome</th>
                      <th class="py-2">Email</th>
                      <th class="py-2">Plano</th>
                      <th class="py-2">Admin</th>
                      <th class="py-2 text-right">A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="admin-users-tbody"></tbody>
                </table>
              </div>
            </div>
            <div class="bg-white border border-slate-200 rounded-2xl p-4">
              <h3 class="font-bold text-lg mb-3">Detalhes do usu√°rio</h3>
              <div id="admin-user-details" class="text-sm text-slate-600">Selecione um usu√°rio‚Ä¶</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal b√°sico -->
  <dialog id="modal" class="rounded-2xl p-0 w-full max-w-lg backdrop:bg-black/40">
    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
      <div class="p-4 border-b flex items-center justify-between">
        <h4 id="modal-title" class="font-bold">Modal</h4>
        <button onclick="closeModal()" class="px-2 py-1 rounded-lg hover:bg-slate-100">‚úñ</button>
      </div>
      <div id="modal-body" class="p-4 text-sm text-slate-700"></div>
      <div class="p-3 border-t flex items-center justify-end gap-2">
        <button onclick="closeModal()" class="px-4 py-2 rounded-xl border">Fechar</button>
      </div>
    </div>
  </dialog>

  <!-- Modal para criar pasta -->
  <dialog id="modal-folder" class="rounded-2xl p-0 w-full max-w-md backdrop:bg-black/40">
    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
      <div class="p-4 border-b flex items-center justify-between">
        <h4 class="font-bold">Nova Pasta</h4>
        <button onclick="closeFolderModal()" class="px-2 py-1 rounded-lg hover:bg-slate-100">‚úñ</button>
      </div>
      <div class="p-4">
        <input type="text" id="folder-name" placeholder="Nome da pasta" class="w-full border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
      </div>
      <div class="p-3 border-t flex items-center justify-end gap-2">
        <button onclick="closeFolderModal()" class="px-4 py-2 rounded-xl border">Cancelar</button>
        <button onclick="createFolder()" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Criar</button>
      </div>
    </div>
  </dialog>

  <script>
    // ==========================
    // Config & helpers
    // ==========================
    const CONFIG = {
      BASE_URL: "http://localhost:3001/api", // URL do seu backend
    };

    const state = {
      token: localStorage.getItem("token") || null,
      user: null,
      files: [],
      cwd: "/",
      admin: { users: [], selected: null },
    };

    function fmtBytes(bytes) {
      if (bytes === 0) return "0 B";
      const k = 1024;
      const sizes = ["B", "KB", "MB", "GB", "TB"]; 
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }

    function toast(msg, type = "info") {
      const id = "t" + Date.now();
      const el = document.createElement("div");
      const colors = {
        info: "bg-slate-900 text-white",
        success: "bg-green-600 text-white",
        warn: "bg-yellow-500 text-black",
        error: "bg-red-600 text-white",
      };
      el.id = id;
      el.className = `${colors[type]} px-4 py-2 rounded-xl shadow-lg text-sm`;
      el.textContent = msg;
      document.getElementById("toast-container").appendChild(el);
      setTimeout(() => el.remove(), 4200);
    }

    function setLoading(btn, loading) {
      if (!btn) return;
      btn.disabled = loading;
      btn.dataset._label = btn.dataset._label || btn.textContent;
      btn.textContent = loading ? "Carregando‚Ä¶" : btn.dataset._label;
      btn.classList.toggle("opacity-60", loading);
    }

    function setPageTitle(t) {
      document.getElementById("page-title").textContent = t;
    }

    function showAuthOnly(show) {
      document.getElementById("sidebar").classList.toggle("hidden", !show);
      document.getElementById("topbar").classList.toggle("hidden", !show);
    }

    function showView(id) {
      for (const v of document.querySelectorAll('[id^="view-"]')) v.classList.add("hidden");
      document.getElementById(id).classList.remove("hidden");
    }

    function openModal(title, html) {
      document.getElementById("modal-title").textContent = title;
      document.getElementById("modal-body").innerHTML = html;
      document.getElementById("modal").showModal();
    }
    
    function closeModal(){ 
      document.getElementById("modal").close(); 
    }

    function openFolderModal(){ 
      document.getElementById("modal-folder").showModal(); 
    }
    
    function closeFolderModal(){ 
      document.getElementById("modal-folder").close(); 
      document.getElementById("folder-name").value = "";
    }

    // ==========================
    // API layer
    // ==========================
    async function api(path, { method = "GET", body, headers } = {}) {
      const url = CONFIG.BASE_URL + path;
      const opts = { method, headers: { "Content-Type": "application/json", ...(headers||{}) } };
      if (state.token) opts.headers["Authorization"] = `Bearer ${state.token}`;
      if (body) opts.body = JSON.stringify(body);
      
      try {
        const res = await fetch(url, opts);
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(text || `HTTP ${res.status}`);
        }
        const ct = res.headers.get("content-type") || "";
        if (ct.includes("application/json")) return res.json();
        return res.text();
      } catch (error) {
        console.error("API Error:", error);
        throw error;
      }
    }

    async function apiUpload(path, file) {
      const url = CONFIG.BASE_URL + path;
      const fd = new FormData();
      fd.append("file", file);
      
      try {
        const res = await fetch(url, { 
          method: "POST", 
          headers: state.token ? { Authorization: `Bearer ${state.token}` } : {}, 
          body: fd 
        });
        
        if (!res.ok) throw new Error(`Upload falhou: ${res.status}`);
        return res.json();
      } catch (error) {
        console.error("Upload Error:", error);
        throw error;
      }
    }

    // ==========================
    // Auth
    // ==========================
    async function handleLogin(ev){
      ev.preventDefault();
      const btn = ev.submitter; 
      setLoading(btn, true);
      
      try {
        const data = Object.fromEntries(new FormData(ev.target));
        const out = await api("/auth/login", { method: "POST", body: data });
        
        state.token = out.token; 
        localStorage.setItem("token", out.token);
        await bootstrapAfterAuth();
        location.hash = "#/dashboard";
        toast("Bem-vindo(a)!", "success");
      } catch (e) { 
        toast("Login inv√°lido: "+ e.message, "error"); 
      } finally { 
        setLoading(btn, false); 
      }
    }

    async function handleRegister(ev){
      ev.preventDefault();
      const btn = ev.submitter; 
      setLoading(btn, true);
      
      try {
        const data = Object.fromEntries(new FormData(ev.target));
        const out = await api("/auth/register", { method: "POST", body: data });
        
        state.token = out.token; 
        localStorage.setItem("token", out.token);
        await bootstrapAfterAuth();
        location.hash = "#/plans";
        toast("Conta criada! Escolha um plano.", "success");
      } catch (e) { 
        toast("Erro ao registrar: "+ e.message, "error"); 
      } finally { 
        setLoading(btn, false); 
      }
    }

    async function logout(){
      state.token = null; 
      localStorage.removeItem("token"); 
      state.user = null;
      showAuthOnly(false);
      showView("view-login");
      location.hash = "#/login";
    }

    // ==========================
    // Render helpers
    // ==========================
    function renderTopbarMini(){
      const mini = document.getElementById("user-mini");
      if (!state.user) { mini.textContent = ""; return; }
      
      mini.innerHTML = `
        <span class='hidden md:inline'>${state.user.name}</span>
        <span class='text-slate-400'>‚Ä¢</span>
        <span>${state.user.email}</span>
      `;
      
      const q = document.getElementById("quota-mini");
      const used = state.user.quota?.usedBytes || 0; 
      const total = state.user.quota?.totalBytes || 1;
      const pct = Math.min(100, Math.round((used/total)*100));
      
      q.classList.remove("hidden");
      q.innerHTML = `
        <div class='w-40 h-2 bg-slate-200 rounded-full overflow-hidden'>
          <div style='width:${pct}%' class='h-full bg-blue-600'></div>
        </div>
        <div class='text-xs text-slate-500'>${fmtBytes(used)} / ${fmtBytes(total)}</div>
      `;
    }

    function renderDashboard(){
      if (!state.user) return;
      
      const used = state.user.quota?.usedBytes || 0;
      const total = state.user.quota?.totalBytes || 1;
      const free = total - used;
      
      document.getElementById("stat-used").textContent = fmtBytes(used);
      document.getElementById("stat-total").textContent = `de ${fmtBytes(total)}`;
      document.getElementById("stat-free").textContent = `${fmtBytes(free)} livres`;
      document.getElementById("bar-usage").style.width = Math.min(100, (used/total)*100) + "%";
      document.getElementById("stat-items").textContent = (state.user?.itemsCount ?? 0).toLocaleString();
      document.getElementById("stat-plan").textContent = state.user?.plan?.name || "‚Äî";
      document.getElementById("stat-renewal").textContent = state.user?.plan?.renewsAt || "‚Äî";

      // Carregar arquivos recentes
      loadRecentFiles();
      
      // Carregar atividades
      loadActivities();
    }

    async function loadRecentFiles() {
      try {
        const out = await api("/files/recent");
        const recentFiles = out.items || [];
        
        const html = recentFiles.length > 0 
          ? recentFiles.map(f => `
            <div class='flex items-center justify-between py-1'>
              <div class='truncate'>${f.name}</div>
              <div class='text-slate-500'>${fmtBytes(f.size)}</div>
            </div>
          `).join("")
          : "Nada recente ainda.";
          
        document.getElementById("recent-files").innerHTML = html;
      } catch (e) {
        document.getElementById("recent-files").innerHTML = "Erro ao carregar.";
      }
    }

    async function loadActivities() {
      try {
        const out = await api("/activity");
        const activities = out.items || [];
        
        const html = activities.length > 0 
          ? activities.map(a => `
            <li class='flex items-center justify-between'>
              <span>${a.action}</span>
              <span class='text-slate-400'>${new Date(a.timestamp).toLocaleString()}</span>
            </li>
          `).join("")
          : "<li>Nenhuma atividade recente</li>";
          
        document.getElementById("activity").innerHTML = html;
      } catch (e) {
        document.getElementById("activity").innerHTML = "<li>Erro ao carregar atividades</li>";
      }
    }

    function renderAccount(){
      const u = state.user || {};
      const el = document.getElementById("account-data");
      el.innerHTML = `
        <div class='bg-slate-50 rounded-xl p-4'><div class='text-slate-500'>Nome</div><div class='font-semibold'>${u.name||"‚Äî"}</div></div>
        <div class='bg-slate-50 rounded-xl p-4'><div class='text-slate-500'>Email</div><div class='font-semibold'>${u.email||"‚Äî"}</div></div>
        <div class='bg-slate-50 rounded-xl p-4'><div class='text-slate-500'>Plano</div><div class='font-semibold'>${u.plan?.name||"‚Äî"}</div></div>
        <div class='bg-slate-50 rounded-xl p-4'><div class='text-slate-500'>Armazenamento</div><div class='font-semibold'>${fmtBytes(u.quota?.usedBytes||0)} / ${fmtBytes(u.quota?.totalBytes||0)}</div></div>
      `;
    }

    function renderFiles(){
      const tbody = document.getElementById("files-tbody");
      const q = document.getElementById("file-search").value.trim().toLowerCase();
      const items = state.files.filter(f => f.name.toLowerCase().includes(q));
      
      tbody.innerHTML = items.map(f => `
        <tr class='border-b'>
          <td class='py-2'>${f.isDir ? "üìÅ" : "üìÑ"} 
            <button class='hover:underline' onclick='onClickEntry(${JSON.stringify(f).replaceAll("'","&#39;")})'>
              ${f.name}
            </button>
          </td>
          <td class='py-2'>${f.isDir ? "‚Äî" : fmtBytes(f.size)}</td>
          <td class='py-2'>${new Date(f.updatedAt).toLocaleString()}</td>
          <td class='py-2 text-right space-x-2'>
            ${f.isDir ? "" : `
              <a href='${CONFIG.BASE_URL}/files/${f.id}/download' class='text-blue-600' target='_blank'>
                Baixar
              </a>
            `}
            <button class='text-red-600' onclick='deleteEntry("${f.id}")'>Excluir</button>
          </td>
        </tr>
      `).join("") || `<tr><td colspan='4' class='py-6 text-center text-slate-500'>Nenhum arquivo.</td></tr>`;
    }

    function renderAdminUsers(){
      const tbody = document.getElementById("admin-users-tbody");
      const q = document.getElementById("admin-user-search").value.trim().toLowerCase();
      const users = state.admin.users.filter(u => 
        u.name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q)
      );
      
      tbody.innerHTML = users.map(u => `
        <tr class='border-b'>
          <td class='py-2'>${u.name}</td>
          <td class='py-2'>${u.email}</td>
          <td class='py-2'>${u.plan?.name||"‚Äî"}</td>
          <td class='py-2'>${u.isAdmin ? "‚úÖ" : "‚Äî"}</td>
          <td class='py-2 text-right'>
            <button class='text-blue-600' onclick='adminSelectUser("${u.id}")'>Ver</button>
          </td>
        </tr>
      `).join("") || `<tr><td colspan='5' class='py-6 text-center text-slate-500'>Sem usu√°rios.</td></tr>`;
    }

    function renderAdminDetails(){
      const box = document.getElementById("admin-user-details");
      const u = state.admin.selected;
      
      if (!u) { 
        box.textContent = "Selecione um usu√°rio‚Ä¶"; 
        return; 
      }
      
      box.innerHTML = `
        <div class='space-y-1'>
          <div><span class='text-slate-500'>Nome:</span> <strong>${u.name}</strong></div>
          <div><span class='text-slate-500'>Email:</span> <strong>${u.email}</strong></div>
          <div><span class='text-slate-500'>Plano:</span> <strong>${u.plan?.name||"‚Äî"}</strong></div>
          <div><span class='text-slate-500'>Admin:</span> <strong>${u.isAdmin?"Sim":"N√£o"}</strong></div>
          <div><span class='text-slate-500'>Uso:</span> <strong>${fmtBytes(u.quota?.usedBytes||0)} / ${fmtBytes(u.quota?.totalBytes||0)}</strong></div>
          <div><span class='text-slate-500'>Itens:</span> <strong>${u.itemsCount||0}</strong></div>
        </div>
        <div class='mt-4 space-y-2'>
          <div>
            <label class='text-sm font-medium'>Plano</label>
            <select id='admin-plan-select' class='mt-1 w-full border-slate-300 rounded-xl'>
              <option value='free' ${u.plan?.id==="free"?"selected":""}>Free</option>
              <option value='pro' ${u.plan?.id==="pro"?"selected":""}>Pro</option>
              <option value='turbo' ${u.plan?.id==="turbo"?"selected":""}>Turbo</option>
            </select>
          </div>
          <div class='flex items-center gap-2'>
            <button onclick='adminChangePlan("${u.id}")' class='px-4 py-2 rounded-xl bg-blue-600 text-white'>Aplicar plano</button>
            <button onclick='adminToggleRole("${u.id}")' class='px-4 py-2 rounded-xl border'>${u.isAdmin?"Remover admin":"Tornar admin"}</button>
          </div>
        </div>
      `;
    }

    // ==========================
    // Actions
    // ==========================
    async function bootstrapAfterAuth(){
      try {
        const me = await api("/me");
        state.user = me;
        document.getElementById("adminOnly").classList.toggle("hidden", !me.isAdmin);
        showAuthOnly(true);
        renderTopbarMini();
        await refreshFiles();
      } catch (e) {
        toast("Sess√£o expirada. Fa√ßa login novamente.", "warn");
        await logout();
      }
    }

    async function refreshFiles(){
      try {
        const out = await api(`/files?path=${encodeURIComponent(state.cwd)}`);
        state.files = out.items || [];
        renderFiles();
      } catch (e) {
        state.files = [];
        renderFiles();
        toast("Erro ao carregar arquivos.", "error");
      }
    }

    async function onClickEntry(entry){
      if (entry.isDir) {
        state.cwd = state.cwd.endsWith('/') ? state.cwd + entry.name : state.cwd + '/' + entry.name;
        document.getElementById("current-path").textContent = state.cwd;
        await refreshFiles();
      } else {
        openModal("Pr√©-visualiza√ß√£o", `
          <div class='text-slate-600'>${entry.name}</div>
          <div class='mt-2 text-xs text-slate-500'>
            ${fmtBytes(entry.size)} ‚Ä¢ ${new Date(entry.updatedAt).toLocaleString()}
          </div>
          <div class='mt-4'>
            <a class='text-blue-600 font-semibold' target='_blank' href='${CONFIG.BASE_URL}/files/${encodeURIComponent(entry.id)}/download'>
              Baixar arquivo
            </a>
          </div>
        `);
      }
    }

    async function deleteEntry(id){
      if (!confirm("Excluir este item?")) return;
      
      try { 
        await api(`/files/${encodeURIComponent(id)}`, { method: "DELETE" }); 
        toast("Item exclu√≠do", "success"); 
        await refreshFiles(); 
      } catch(e) { 
        toast("Falha ao excluir: "+e.message, "error"); 
      }
    }

    async function createFolder() {
      const folderName = document.getElementById("folder-name").value.trim();
      if (!folderName) {
        toast("Digite um nome para a pasta", "error");
        return;
      }
      
      try {
        await api("/files/folder", { 
          method: "POST", 
          body: { 
            path: state.cwd, 
            name: folderName 
          } 
        });
        
        toast("Pasta criada com sucesso", "success");
        closeFolderModal();
        await refreshFiles();
      } catch (e) {
        toast("Erro ao criar pasta: " + e.message, "error");
      }
    }

    // Uploads
    function initUploads(){
      const dz = document.getElementById("dropzone");
      const input = document.getElementById("file-input");

      function handleFiles(files){
        for (const f of files) uploadOne(f);
      }
      
      dz.addEventListener("dragover", e => { 
        e.preventDefault(); 
        dz.classList.add("dragover"); 
      });
      
      dz.addEventListener("dragleave", () => dz.classList.remove("dragover"));
      
      dz.addEventListener("drop", e => { 
        e.preventDefault(); 
        dz.classList.remove("dragover"); 
        handleFiles(e.dataTransfer.files); 
      });
      
      input.addEventListener("change", e => handleFiles(e.target.files));
    }

    async function uploadOne(file){
      const row = document.createElement("div");
      row.className = "mt-3 text-sm";
      row.innerHTML = `
        <div class='flex items-center justify-between'>
          <div class='truncate'>‚¨ÜÔ∏è ${file.name}</div>
          <div class='text-slate-500'>${fmtBytes(file.size)}</div>
        </div>
        <div class='h-2 mt-2 bg-slate-200 rounded-full overflow-hidden'>
          <div class='h-full bg-blue-600' style='width:0%'></div>
        </div>
      `;
      
      document.getElementById("view-backups").querySelector(".bg-white").appendChild(row);

      try {
        // Usando XHR para acompanhar progresso
        await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open("POST", `${CONFIG.BASE_URL}/files/upload?path=${encodeURIComponent(state.cwd)}`);
          
          if (state.token) {
            xhr.setRequestHeader("Authorization", `Bearer ${state.token}`);
          }
          
          xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
              const pct = Math.round((e.loaded / e.total) * 100);
              row.querySelector(".bg-blue-600").style.width = pct + "%";
            }
          };
          
          xhr.onload = () => {
            if (xhr.status >= 200 && xhr.status < 300) {
              resolve(JSON.parse(xhr.responseText));
            } else {
              reject(new Error("HTTP " + xhr.status));
            }
          };
          
          xhr.onerror = () => reject(new Error("Erro de rede"));
          
          const fd = new FormData();
          fd.append("file", file);
          xhr.send(fd);
        });
        
        toast(`Upload conclu√≠do: ${file.name}`, "success");
        await refreshFiles();
      } catch (e) { 
        toast("Falha no upload: "+ e.message, "error"); 
      }
    }

    // Plan selection
    async function selectPlan(planId){
      try { 
        await api("/plans/select", { method: "POST", body: { planId } }); 
        toast("Plano atualizado!", "success"); 
        await bootstrapAfterAuth(); 
      } catch(e) { 
        toast("Erro ao aplicar plano: "+e.message, "error"); 
      }
    }

    // Admin actions
    async function loadAdminUsers(){
      try { 
        const out = await api("/admin/users"); 
        state.admin.users = out.items || []; 
        renderAdminUsers(); 
      } catch(e) { 
        state.admin.users = []; 
        renderAdminUsers();
        toast("Erro ao carregar usu√°rios: " + e.message, "error");
      }
    }

    async function adminSelectUser(id){
      try { 
        const u = await api(`/admin/users/${encodeURIComponent(id)}`); 
        state.admin.selected = u; 
        renderAdminDetails(); 
      } catch(e) { 
        toast("Falha ao carregar usu√°rio: "+e.message, "error"); 
      }
    }

    async function adminToggleRole(id){
      try {
        const u = state.admin.selected; 
        const makeAdmin = !u.isAdmin;
        
        await api(`/admin/users/${encodeURIComponent(id)}/role`, { 
          method: "POST", 
          body: { isAdmin: makeAdmin } 
        });
        
        toast(makeAdmin ? "Concedido admin" : "Removido admin", "success");
        await loadAdminUsers();
        await adminSelectUser(id);
      } catch(e) { 
        toast("Erro ao alterar papel: "+e.message, "error"); 
      }
    }

    async function adminChangePlan(id){
      try {
        const planId = document.getElementById("admin-plan-select").value;
        
        await api(`/admin/users/${encodeURIComponent(id)}/plan`, { 
          method: "POST", 
          body: { planId } 
        });
        
        toast("Plano alterado", "success");
        await loadAdminUsers();
        await adminSelectUser(id);
      } catch(e) { 
        toast("Erro ao alterar plano: "+e.message, "error"); 
      }
    }

    // ==========================
    // Router (hash)
    // ==========================
    const routes = {
      "#/login": () => { 
        showAuthOnly(false); 
        showView("view-login"); 
        setPageTitle("Login"); 
      },
      "#/register": () => { 
        showAuthOnly(false); 
        showView("view-register"); 
        setPageTitle("Criar conta"); 
      },
      "#/dashboard": async () => { 
        requireAuth(); 
        showView("view-dashboard"); 
        setPageTitle("Dashboard"); 
        renderDashboard(); 
      },
      "#/backups": async () => { 
        requireAuth(); 
        showView("view-backups"); 
        setPageTitle("Backups"); 
        renderFiles(); 
      },
      "#/plans": async () => { 
        requireAuth(); 
        showView("view-plans"); 
        setPageTitle("Planos"); 
      },
      "#/account": async () => { 
        requireAuth(); 
        showView("view-account"); 
        setPageTitle("Minha conta"); 
        renderAccount(); 
      },
      "#/admin": async () => { 
        requireAuth(); 
        if (!state.user?.isAdmin) { 
          location.hash = "#/dashboard"; 
          return; 
        } 
        showView("view-admin"); 
        setPageTitle("Admin"); 
        await loadAdminUsers(); 
      },
    };

    function requireAuth(){
      if (!state.token) { 
        location.hash = "#/login"; 
        throw new Error("auth"); 
      }
      showAuthOnly(true);
      renderTopbarMini();
      document.getElementById("adminOnly").classList.toggle("hidden", !state.user?.isAdmin);
    }

    function onRoute(){
      const h = location.hash || (state.token ? "#/dashboard" : "#/login");
      const fn = routes[h] || routes["#/dashboard"];
      
      try {
        fn();
      } catch (e) {
        console.error("Routing error:", e);
      }
      
      // marcar nav ativo
      document.querySelectorAll(".navlink").forEach(a => {
        const active = a.dataset.route === h; 
        a.classList.toggle("bg-blue-100", active);
        a.classList.toggle("text-blue-800", active);
      });
    }

    // ==========================
    // Events & init
    // ==========================
    document.getElementById("form-login").addEventListener("submit", handleLogin);
    document.getElementById("form-register").addEventListener("submit", handleRegister);
    document.getElementById("btn-logout").addEventListener("click", logout);
    
    document.getElementById("btn-open-sidebar").addEventListener("click", () => {
      const sb = document.getElementById("sidebar");
      const wasHidden = sb.classList.contains("hidden");
      sb.classList.toggle("hidden", !wasHidden);
      
      if (wasHidden) {
        sb.classList.add("fixed", "z-40", "h-full", "inset-0", "w-[var(--sidebar-w)]");
      } else {
        sb.classList.remove("fixed", "z-40", "h-full", "inset-0");
      }
    });

    document.querySelectorAll(".navlink").forEach(btn => {
      btn.addEventListener("click", () => { 
        location.hash = btn.dataset.route; 
      });
    });

    document.querySelectorAll(".btn-select-plan").forEach(btn => {
      btn.addEventListener("click", () => selectPlan(btn.dataset.planId));
    });

    document.getElementById("file-search").addEventListener("input", renderFiles);
    document.getElementById("btn-create-folder").addEventListener("click", openFolderModal);
    document.getElementById("admin-user-search").addEventListener("input", renderAdminUsers);

    initUploads();
    window.addEventListener("hashchange", onRoute);

    // Auto-login bootstrap
    (async function init(){
      if (state.token) {
        try { 
          await bootstrapAfterAuth(); 
          showAuthOnly(true); 
          location.hash = location.hash || "#/dashboard"; 
        } catch (e) { 
          console.error("Bootstrap error:", e);
          logout(); 
        }
      } else {
        showAuthOnly(false); 
        showView("view-login");
      }
      onRoute();
    })();
  </script>
</body>
</html>